#!/bin/sh
installpath=/var/lib/hakchi
rootfs=$installpath/rootfs
gamepath=$rootfs/usr/share/games/nes/kachikachi
state_file=$installpath/menu

[ -z "$1" ] && exit 0
prev_code=$(cat "$state_file")
[ "$1" == "$prev_code" ] && exit 0

echo Switching to menu $1
if [ "$1" == "000" ]; then
  targetpath=$gamepath
else
  targetpath=$gamepath/$1
fi

[ -d "$targetpath" ] || exit 1
echo $1 > "$state_file"

echo New directory: $targetpath
if [ ! -f "$targetpath/title.fnt" ]; then
  ln -s "$gamepath/title.fnt" "$targetpath/title.fnt"
fi
if [ ! -f "$targetpath/copyright.fnt" ]; then
  ln -s "$gamepath/copyright.fnt" "$targetpath/copyright.fnt"
fi

pkill -KILL clover-mcp
pkill -KILL ReedPlayer-Clover

umount -f /usr/share/games/nes/kachikachi
mount -o bind "$targetpath" /usr/share/games/nes/kachikachi
clover-mcp
