rand(){
  hexdump -e '"%x"' -n 4 /dev/urandom
}

source_parts(){
  script=$temppath/script_$(rand)
  rm -f "$script"
  for i in $(find $(dirname "$1") -maxdepth 1 -path "$1" | sort); do
    cat "$i" >> "$script"
  done
  source "$script"
  rm -f "$script"
}

preinit(){
	modname=hakchi
	modpath=/$modname
	mountpoint=/newroot
	installpath=$mountpoint/var/lib/$modname
	rootfs=$installpath/rootfs
	preinit=$rootfs/etc/preinit
	preinitpath=$preinit.d

	echo Starting $modname

	mount -o bind $rootfs/bin /bin
	source "$installpath/script/base"
  source_parts "$preinitpath/p????_*"
}
