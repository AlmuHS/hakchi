if [ -f $installpath/menu ]; then
  echo Erasing last menu state...
  rm $installpath/menu
fi

if [ "$hakchi_remove_games" == "y" ] && [ "$hakchi_partial_first" == "y" ]; then
  echo Removing all games...
  rm -rf $rootfs/usr/share/games/nes/kachikachi/*
fi

if [ "$hakchi_original_games" == "y" ] && [ "$hakchi_partial_first" == "y" ]; then
  echo Transfering original games...
  for dir in $mountpoint/usr/share/games/nes/kachikachi/*; do
    if [ -d $dir ]; then
      code=`echo $dir | sed "s/.*\///"`
      if [ -f /$modname/hidden_games ] && grep -q $code /$modname/hidden_games; then
        echo $code is hidden
      else
        echo Transfering $code
        found=false
        for p in /games/gpath-$code-*; do
          if [ -f "$p" ]; then
            dist=`cat $p`
            mkdir -p $rootfs/usr/share/games/nes/kachikachi/$dist
            echo ...to $rootfs/usr/share/games/nes/kachikachi/$dist
            cp -a $mountpoint/usr/share/games/nes/kachikachi/$code $rootfs/usr/share/games/nes/kachikachi/$dist
            rm $p
            found=true
          fi
        done
        if [ "$found" == "false" ]; then
          echo There is no path file for $code
          cp -a $mountpoint/usr/share/games/nes/kachikachi/$code $rootfs/usr/share/games/nes/kachikachi/
        fi
      fi
    fi
  done
fi

if [ "$hakchi_remove_armet_original" == "y" ] && [ "$hakchi_partial_first" == "y" ]; then
  echo "Removing armet filter..."
  find $rootfs/usr/share/games/nes/kachikachi -name *.desktop -exec sed -i -e 's/--enable-armet//g' {} +
fi

if [ -d /games ]; then
  echo Transferring new games...
  cp -a /games/* $rootfs/usr/share/games/nes/kachikachi
fi

if [ "$hakchi_remove_armet_all" == "y" ] && [ "$hakchi_partial_last" == "y" ]; then
  echo Removing armet filter...
  find $rootfs/usr/share/games/nes/kachikachi -name *.desktop -exec sed -i -e 's/--enable-armet//g' {} +
fi

if [ -f "$hakchi_extra_args_file" ] && [ "$hakchi_partial_last" == "y" ]; then
  echo Appending extra command line arguments...
  find $rootfs/usr/share/games/nes/kachikachi -name *.desktop -exec awk -v cfile="$hakchi_extra_args_file" 'BEGIN{getline c < cfile} /Exec=\/usr\//{$0=$0 " " c} {l[ln++]=$0} END{for(i=0;i<ln;i++) print l[i]>ARGV[1]}' {} +
fi

if [ "$hakchi_partial_first" == "y" ]; then
  if [ -d /transfer ]; then
    echo Transferring extra data...
    cp -a /transfer/* $installpath/
  fi
fi

if [ -f "$hakchi_extra_script" ]; then
  echo 1
  echo Executing extra script...
  . "$hakchi_extra_script"
fi
